<!DOCTYPE html>
<html>
<head>
  <meta property="og:title" content="SOFAR – Running Distance Map">
  <meta property="og:description" content="See how far your yearly kilometers would take you on a real map.">
  <meta property="og:image" content="https://sofar.run/og-image-sofar.png">
  <meta property="og:url" content="https://sofar.run">
  <meta name="twitter:card" content="summary_large_image">
  <meta charset="utf-8">
  <title>SOFAR – Running Distance Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon-vibrant.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
      background-color: #f9f9f9;
      color: #333;
    }
    .logo-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5em;
    }
    .logo-icon {
      height: 100px;
      width: auto;
    }
    .logo-text {
      font-size: 1.5em;
      font-weight: bold;
      color: #FF6A13;
      margin-left: 0.5em;
    }
    p.header-subtext {
      text-align: center;
      font-size: 1.2em;
      margin-top: 0;
      margin-bottom: 1em;
      color: #333;
    }
    input, select, button {
      padding: 0.75em;
      margin: 0.5em auto;
      width: 100%;
      max-width: 400px;
      display: block;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #FF6A13;
      color: white;
      font-weight: bold;
      border: none;
    }
    button:hover {
      background-color: #cc5810;
    }
    #map {
      height: 60vh;
      margin: 1em auto;
      max-width: 100%;
      border: 2px solid #FF6A13;
      border-radius: 5px;
    }
    #info {
      margin: 1em auto;
      font-weight: bold;
      text-align: center;
      color: red;
    }
    label[for="mode"] {
      display: block;
      text-align: center;
      font-weight: bold;
      margin-top: 1em;
      color: #FF6A13;
    }
    footer {
      text-align: center;
      font-size: 0.8em;
      color: #888;
      margin-top: 2em;
    }
    @media (max-width: 600px) {
      .logo-text { font-size: 1.2em; }
      p.header-subtext { font-size: 1em; }
      input, select, button { font-size: 0.95em; }
    }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="logo-sofar-path.png" alt="SOFAR Logo" class="logo-icon" style="background: transparent;">
  </div>
  <p class="header-subtext">How far have you run?</p>

  <label for="mode">Mode:</label>
  <select id="mode">
    <option value="direction">City + Direction + Distance</option>
    <option value="destination">City + Destination + Distance</option>
  </select>

  <input type="text" id="city" placeholder="Starting city (e.g., Berlin)">
  <input type="number" id="distance" placeholder="Distance run (km)">
  <select id="direction" style="display: block;">
    <option value="N">North</option>
    <option value="NE">Northeast</option>
    <option value="E">East</option>
    <option value="SE">Southeast</option>
    <option value="S">South</option>
    <option value="SW">Southwest</option>
    <option value="W">West</option>
    <option value="NW">Northwest</option>
  </select>
  <input type="text" id="destCity" placeholder="Destination city" style="display: none;">

  <div id="info"></div>
  <button onclick="showDistance()">Show Distance</button>
  <div id="map" style="position: relative;"></div>
  
  <img src="logo-sofar-path.png" alt="SOFAR watermark" style="position: absolute; top: 20px; left: 20px; height: 60px; pointer-events: none; z-index: 500;">
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        const active = document.activeElement;
        if (active.tagName === 'INPUT' || active.tagName === 'SELECT') {
          event.preventDefault();
          showDistance();
        }
      }
    });

    let map = L.map('map', {
      center: [51, 10],
      zoom: 6,
      layers: []
    });

    const baseLayers = {
      'Standard': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }),
      'Gray': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap, &copy; CartoDB'
      })
    };

    baseLayers['Standard'].addTo(map);
    L.control.layers(baseLayers).addTo(map);

    async function geocode(city) {
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
      const data = await res.json();
      if (!data.length) throw new Error('City not found.');
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function showDistance() {
      const apiKey = ''; // API key is handled server-side
      const mode = document.getElementById('mode').value;
      const city = document.getElementById('city').value;
      const km = parseFloat(document.getElementById('distance').value);
      if (!city || isNaN(km)) { alert('Please enter a starting city and distance.'); return; }

      let startCoords;
      try {
        startCoords = await geocode(city);
      } catch (e) {
        alert(e.message);
        return;
      }

      let routeCoords = [];
      document.getElementById('info').textContent = '';

      if (mode === 'direction') {
        const dir = document.getElementById('direction').value;
        const angles = {N:0, NE:45, E:90, SE:135, S:180, SW:225, W:270, NW:315};
        const angle = angles[dir] * Math.PI / 180;
        const deltaLat = (km / 111) * Math.cos(angle);
        const deltaLon = (km / 85) * Math.sin(angle);
        const end = [startCoords[0] + deltaLat, startCoords[1] + deltaLon];
        const res = await fetch(`https://small-feather-163d.schaefer-jesco.workers.dev?point=${startCoords[0]},${startCoords[1]}&point=${end[0]},${end[1]}&vehicle=foot&points_encoded=false&key=${apiKey}`);
        const data = await res.json();
        if (!data.paths?.length) {
          document.getElementById('info').textContent = `No route could be generated in that direction. You may have reached the sea or an unreachable area.`;
          document.getElementById('info').scrollIntoView({ behavior: 'smooth', block: 'center' });
          return;
        }
        routeCoords = data.paths[0].points.coordinates.map(c => [c[1], c[0]]);
      } else {
        const dest = document.getElementById('destCity').value;
        if (!dest) {
          alert('Please enter a destination city.');
          return;
        }
        let endCoords;
        try {
          endCoords = await geocode(dest);
        } catch (e) {
          alert(e.message);
          return;
        }
        const res = await fetch(`https://small-feather-163d.schaefer-jesco.workers.dev?point=${startCoords[0]},${startCoords[1]}&point=${endCoords[0]},${endCoords[1]}&vehicle=foot&points_encoded=false&key=${apiKey}`);
        const data = await res.json();
        if (!data.paths?.length) {
          alert('No route found.');
          return;
        }
        const full = data.paths[0].points.coordinates.map(c => [c[1], c[0]]);
        let total = 0;
        routeCoords.push(full[0]);
        for (let i = 1; i < full.length; i++) {
          const [a, b] = full[i - 1], [c, d] = full[i];
          const dist = distanceKm(a, b, c, d);
          if (total + dist > km) break;
          total += dist;
          routeCoords.push(full[i]);
        }
        const remaining = Math.max(0, data.paths[0].distance / 1000 - km).toFixed(1);
        document.getElementById('info').textContent = `You ran ${km.toFixed(1)} km. ${remaining} km to go.`;
        document.getElementById('info').scrollIntoView({ behavior: 'smooth', block: 'center' });
      }

      map.eachLayer(layer => {
        if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
      });

      L.marker(startCoords, {icon: L.divIcon({className: 'custom-marker', html: '<div style="background-color:#FF6A13;width:14px;height:14px;border-radius:50%"></div>'})}).addTo(map).bindPopup('Start: ' + city).openPopup();
      const last = routeCoords[routeCoords.length - 1];
      L.marker(last, {icon: L.divIcon({className: 'custom-marker', html: '<div style="background-color:#FF6A13;width:14px;height:14px;border-radius:50%"></div>'})}).addTo(map).bindPopup(`${km.toFixed(1)} km`).openPopup();
      L.polyline(routeCoords, { color: '#FF6A13' }).addTo(map);
      map.fitBounds(routeCoords);
    }
  </script>
  <footer>© 2025 SOFAR. All rights reserved.<br><a href="#impressum" onclick="toggleLegal('impressum')">Legal Notice</a> · <a href="#datenschutz" onclick="toggleLegal('datenschutz')">Privacy</a>
  </footer>
  <div id="legal-text" style="display:none; max-width:600px; margin:2em auto; font-size:0.9em; line-height:1.5; color:#444;"></div>
  <script>
    function toggleLegal(section) {
      const el = document.getElementById('legal-text');
      el.style.display = 'block';
      if (section === 'impressum') {
        el.innerHTML = '<h2>Legal Notice</h2><p>Information according to § 5 TMG</p><p>Jesco Fabian Schäfer<br>Blumenwerderstr. 10<br>16225 Eberswalde<br>Germany</p><p>Email: schaefer.jesco@gmail.com</p>';
      } else if (section === 'datenschutz') {
        el.innerHTML = '<h2>Privacy Policy</h2><p>No personal data is stored or processed by the operator of this site. This website does not use cookies, analytics tools, or advertising trackers. Map requests are processed anonymously by external routing services (GraphHopper).</p>';
      }
      window.scrollTo({ top: el.offsetTop - 20, behavior: 'smooth' });
    }
  </script>
</body>
</html>
