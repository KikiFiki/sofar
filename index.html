<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>sofar – Lauf‑Distanz Karte</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="favicon-vibrant.ico" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 1em;
      background-color: #f9f9f9;
      color: #333;
    }
    .logo {
      display: block;
      margin: 0.5em auto;
      height: 50px;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
      margin-bottom: 0.5em;
      color: #FF6A13;
    }
    input, select, button {
      padding: 0.75em;
      margin: 0.5em auto;
      width: 100%;
      max-width: 400px;
      display: block;
      font-size: 1em;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #FF6A13;
      color: white;
      font-weight: bold;
      border: none;
    }
    button:hover {
      background-color: #cc5810;
    }
    #map {
      height: 60vh;
      margin: 1em auto;
      max-width: 100%;
      border: 2px solid #FF6A13;
      border-radius: 5px;
    }
    #info {
      margin: 1em auto;
      font-weight: bold;
      text-align: center;
      color: #444;
    }
    label[for="mode"] {
      display: block;
      text-align: center;
      font-weight: bold;
      margin-top: 1em;
      color: #FF6A13;
    }
    footer {
      text-align: center;
      font-size: 0.8em;
      color: #888;
      margin-top: 2em;
    }
    @media (max-width: 600px) {
      h1 { font-size: 1.2em; }
      input, select, button { font-size: 0.95em; }
    }
  </style>
</head>
<body>
  <img src="logo-shoe.png" alt="sofar Logo" class="logo">
  <h1>sofar</h1>

  <input type="text" id="apikey" placeholder="GraphHopper API Key eingeben">

  <label for="mode">Modus:</label>
  <select id="mode">
    <option value="richtung">Stadt + Richtung + Entfernung</option>
    <option value="zielstadt">Stadt + Zielstadt + Entfernung</option>
  </select>

  <input type="text" id="city" placeholder="Startstadt (z. B. Berlin)">
  <input type="number" id="distance" placeholder="Gelaufene Kilometer">
  <select id="direction" style="display: block;">
    <option value="N">Norden</option>
    <option value="NO">Nordosten</option>
    <option value="O">Osten</option>
    <option value="SO">Südosten</option>
    <option value="S">Süden</option>
    <option value="SW">Südwesten</option>
    <option value="W">Westen</option>
    <option value="NW">Nordwesten</option>
  </select>
  <input type="text" id="destCity" placeholder="Zielstadt" style="display: none;">

  <button onclick="showDistance()">Anzeigen</button>
  <div id="map"></div>
  <div id="info"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([51, 10], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap-Mitwirkende'
    }).addTo(map);

    document.getElementById('mode').addEventListener('change', () => {
      const mode = document.getElementById('mode').value;
      document.getElementById('direction').style.display = mode === 'richtung' ? 'block' : 'none';
      document.getElementById('destCity').style.display = mode === 'zielstadt' ? 'block' : 'none';
    });

    async function geocode(city) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.length === 0) throw new Error('Stadt nicht gefunden.');
      return [parseFloat(data[0].lat), parseFloat(data[0].lon)];
    }

    function distanceKm(lat1, lon1, lat2, lon2) {
      const R = 6371;
      const dLat = (lat2 - lat1) * Math.PI / 180;
      const dLon = (lon2 - lon1) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function showDistance() {
      const apiKey = document.getElementById('apikey').value.trim();
      if (!apiKey) { alert('Bitte gültigen API-Key eingeben.'); return; }
      const mode = document.getElementById('mode').value;
      const startCity = document.getElementById('city').value;
      const km = parseFloat(document.getElementById('distance').value);
      if (!startCity || isNaN(km)) { alert('Bitte Stadt und Entfernung eingeben.'); return; }

      let startCoords;
      try { startCoords = await geocode(startCity); } catch (e) { alert(e.message); return; }
      let routeCoords = [];

      if (mode === 'richtung') {
        const dir = document.getElementById('direction').value;
        const angles = {N:0, NO:45, O:90, SO:135, S:180, SW:225, W:270, NW:315};
        const ang = angles[dir]*Math.PI/180;
        const dLat=km/111*Math.cos(ang), dLon=km/85*Math.sin(ang);
        const end=[startCoords[0]+dLat, startCoords[1]+dLon];
        const data=await (await fetch(`https://graphhopper.com/api/1/route?point=${startCoords[0]},${startCoords[1]}&point=${end[0]},${end[1]}&vehicle=foot&points_encoded=false&key=${apiKey}`)).json();
        if(!data.paths?.length){alert('Keine Route.');return;}
        routeCoords=data.paths[0].points.coordinates.map(c=>[c[1],c[0]]);
      } else {
        const dest = document.getElementById('destCity').value;
        if(!dest){alert('Zielstadt fehlt.');return;}
        let end;
        try{end=await geocode(dest);}catch(e){alert(e.message);return;}
        const data=await (await fetch(`https://graphhopper.com/api/1/route?point=${startCoords[0]},${startCoords[1]}&point=${end[0]},${end[1]}&vehicle=foot&points_encoded=false&key=${apiKey}`)).json();
        if(!data.paths?.length){alert('Keine Route.');return;}
        const full=data.paths[0].points.coordinates.map(c=>[c[1],c[0]]);
        let tot=0; routeCoords.push(full[0]);
        for(let i=1;i<full.length;i++){const [a1,b1]=full[i-1], [a2,b2]=full[i]; const d=distanceKm(a1,b1,a2,b2); if(tot+d>km) break; tot+=d; routeCoords.push(full[i]);}
        const rem=Math.max(0,data.paths[0].distance/1000-km).toFixed(1);
        document.getElementById('info').textContent=`Du hast ${km.toFixed(1)}km geschafft. Noch ${rem}km bis Z.`;
      }

      map.eachLayer(l=>{if(l instanceof L.Marker||l instanceof L.Polyline) map.removeLayer(l);});
      L.marker(startCoords).addTo(map).bindPopup('Start '+startCity).openPopup();
      const e=routeCoords.slice(-1)[0];
      L.marker(e).addTo(map).bindPopup(`${km.toFixed(1)}km`).openPopup();
      L.polyline(routeCoords,{color:'#FF6A13'}).addTo(map);
      map.fitBounds(routeCoords);
    }
  </script>
  <footer>© 2025 sofar. Alle Rechte vorbehalten.</footer>
</body>
</html>
